<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="「BUAA-CO」 P5课下, Cordial-Kid">
    <meta name="description" content="序言从P5开始，我们迎来了崭新的篇章，5级流水线。我真的想不出什么其他词汇来形容他的伟大，总之他让无数学生为之倾倒，也让少数情侣为之分道扬镳(别怕)。从这一章节开始，我们设计的CPU难度有了质的飞跃。
相信很多同学在听了计组理论课关于阻塞和">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>「BUAA-CO」 P5课下 | Cordial-Kid</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Cordial-Kid</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Cordial-Kid</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Cordial-Kid/my-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Cordial-Kid/my-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/17.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">「BUAA-CO」 P5课下</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/BUAA/">
                                <span class="chip bg-color">BUAA</span>
                            </a>
                        
                            <a href="/tags/verilog/">
                                <span class="chip bg-color">verilog</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90/" class="post-category">
                                计算机组成
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2026-01-21
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    4.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    19 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h2><p>从P5开始，我们迎来了崭新的篇章，<code>5级流水线</code>。我真的想不出什么其他词汇来形容他的伟大，总之他让无数学生为之倾倒，也让<code>少数</code>情侣为之分道扬镳(别怕)。从这一章节开始，我们设计的CPU难度有了质的飞跃。</p>
<p>相信很多同学在听了计组理论课关于<code>阻塞</code>和<code>转发</code>的讲解后一头雾水，看了学长的代码之后仍然有一万个为什么。这篇文章笔者将以五级流水线的具体设计为主线，尽可能地解答大家在设计过程中遇到的疑惑，希望能给大家带来一些帮助，如有不详尽之处还请大家多多包涵，也欢迎大家批评指正。</p>
<h2 id="关于命名方式的一些Tips"><a href="#关于命名方式的一些Tips" class="headerlink" title="关于命名方式的一些Tips"></a>关于命名方式的一些Tips</h2><p>在五级流水线的设计中我们会遇到数不尽的端口，如果命名方式不合理，可能我们在 <code>VScode</code> 的提示下也会云里雾里，但是如果我们有一套自己的命名规则，那么我们可以清楚地识别哪些是端口名称，哪些是连线(实例化时的<code>wire</code>型变量)的名称，从而极大地缩减编码时的工作量和<code>bug</code>率。</p>
<p>笔者习惯将端口名称大写，将连线名称小写，(<code>clk</code>和<code>reset</code>除外)虽然这种方式不能借助ISE的实例化工具完成，但是至少于编程者而言各变量的含义了然于心，不会越编越乱，以至于自己都不知道自己在干什么。怎么说呢，每个人有每个人独特的方式，大家只要探索到适合自己的命名方式就好。</p>
<h2 id="设计综述"><a href="#设计综述" class="headerlink" title="设计综述"></a>设计综述</h2><p>五级流水线，顾名思义，当然要弄清楚是哪五级，以及分别有哪些流水线寄存器，以及每一级都包含哪些元件。</p>
<blockquote>
<p>F级: IFU<br>D级：CMP,EXT,GRF,NPC,D_reg<br>E级：E_ALU,E_reg<br>M级：M_DM,M_reg<br>W级：W_reg</p>
</blockquote>
<p>显然，五级流水线，四个流水线寄存器，构成了P5设计的基本框架。除此之外，还有<code>Stall</code>模块用来处理阻塞，<code>mips</code>模块在组装元件的过程中实现转发，<code>def</code>模块定义一些宏，<code>CTRL</code>模块实现控制信号以及配合<code>Stall</code>模块实现阻塞判断。</p>
<p>设计图可以参照：<br><img src="/images/Five-Stage_Pipeline_Logisim_Schematic.png" alt="Five-Stage Pipeline Logisim Schematic"></p>
<p>P5课下要求实现的指令是：add, sub, ori, lw, sw, beq, lui, jal, jr, nop。由于接口繁多，笔者在搭建时本着接口<code>能少就少</code>的原则完成设计，(当然也要给课上留好一定的扩展接口)。</p>
<p>在大家大概了解了每一个模块的作用以及我们要实现的具体指令以后我们就可以进入详细的设计分析了。</p>
<h2 id="F-IFU"><a href="#F-IFU" class="headerlink" title="F_IFU"></a>F_IFU</h2><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> F_IFU (</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] NPC,</span><br><span class="line">    <span class="keyword">input</span> clk,</span><br><span class="line">    <span class="keyword">input</span> reset,</span><br><span class="line">    <span class="keyword">input</span> PCWE,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] PC,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] Instr</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><code>F_IFU</code>和<code>P4</code>相比变化不大只是在输入中新增了<code>PCWE</code>。当<code>Stall</code>生效时，<code>IFU</code>中的<code>PC</code>不再更新，直到阻塞结束。</p>
<h2 id="D-reg"><a href="#D-reg" class="headerlink" title="D_reg"></a>D_reg</h2><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> D_reg (</span><br><span class="line">    <span class="keyword">input</span> clk,</span><br><span class="line">    <span class="keyword">input</span> reset,</span><br><span class="line">    <span class="keyword">input</span> Flush,   </span><br><span class="line">    <span class="keyword">input</span> WE,    </span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] F_PC,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] F_Instr,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] D_PC,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] D_Instr</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>D级寄存器负责连接F级和D级流水线，因为课程组规定阻塞只能发生在<strong>D级</strong>，因此当阻塞指令生效时，<code>WE</code>禁止向<code>D级</code>寄存器写入指令，<code>Flush</code>刷新E级寄存器为<code>nop</code>，从而使得<code>nop</code>信号随着流水线流下去，从而实现阻塞。</p>
<blockquote>
<p>Q: PC和Instr要一直流水下去吗？<br>A: 是的。只有PC和instr随流水线一直流水下去我们才能判断每一级流水线的当前指令是什么。</p>
</blockquote>
<p><strong>instr主要用途</strong>：阻塞判断，每一级流水线译码(分布式)。<br><strong>PC主要用途</strong>：<code>DM</code>要输出<code>PC</code>，<code>jal</code>指令向<code>GPR[rs]</code>写入涉及<code>PC</code>，</p>
<h2 id="D-EXT"><a href="#D-EXT" class="headerlink" title="D_EXT"></a>D_EXT</h2><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> D_EXT (</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">15</span>:<span class="number">0</span>] imm,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] ext,</span><br><span class="line">    <span class="keyword">input</span> EXTOp</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><code>EXT</code>和<code>P4</code>没有什么区别。</p>
<h2 id="D-CMP"><a href="#D-CMP" class="headerlink" title="D_CMP"></a>D_CMP</h2><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> D_CMP (</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] RS,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] RT,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">2</span>:<span class="number">0</span>] CMPOp,    <span class="comment">//提前为其他转移信号留下接口</span></span><br><span class="line">    <span class="keyword">output</span> Beq_jump</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><code>D_CMP</code>存在的意义是将<code>BEQ</code>的比较提前，这样可以尽早判断是否跳转，减少流水线的”白流”。</p>
<h2 id="D-NPC"><a href="#D-NPC" class="headerlink" title="D_NPC"></a>D_NPC</h2><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> D_NPC (</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] F_PC,   <span class="comment">//正常计算F_PC+4</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] D_PC,   <span class="comment">//流水</span></span><br><span class="line">    <span class="keyword">input</span> Beq_jump,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">2</span>:<span class="number">0</span>] NPCOp,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] RA,     <span class="comment">//jr和jalr用</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">25</span>:<span class="number">0</span>] IMM,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] NPC</span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<p>在<code>D_NPC</code>模块的接口相较于<code>P4</code>多出了<code>Beq_jump</code>,<code>F_PC</code>,<code>D_PC</code>三个信号。<code>Beq_jump</code>不必赘述，我们重点区分一下<code>F_PC</code>和<code>D_PC</code>以及他们的用法。<br>首先大家需要明确,在一般情况下:<code>F_PC = D_PC + 4</code>。(因为流水线走了一级嘛)。</p>
<p>接着我们来看一个流水线简图：</p>
<table>
<thead>
<tr>
<th>时钟周期</th>
<th>F级（取指）</th>
<th>D级（译码）</th>
<th>E级（执行）</th>
<th>M级（访存）</th>
<th>W级（写回）</th>
</tr>
</thead>
<tbody><tr>
<td>拍1</td>
<td>取 BEQ（0x00）</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>拍2</td>
<td>取下条 A（0x04）</td>
<td>译 BEQ（0x00）并判断</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>拍3</td>
<td>取下下条 B（0x?）</td>
<td>译下条 A（0x04）</td>
<td>执行BEQ对地址的更改</td>
<td>-</td>
<td>-</td>
</tr>
</tbody></table>
<p>我们可以采用类似延迟槽的思想，<code>A</code>指令无论如何都会被执行，那么我们重点考虑<code>B</code>指令。</p>
<p><strong>如果</strong> <code>Beq_jump = 0</code>，我们应该接着F_PC取PC + 4，这也就决定了<code>assign PC_4 = F_PC + 4</code>;</p>
<p><strong>如果</strong> <code>Beq_jump = 1</code>，那我们根据Beq的RTL语言。PC+4使用的应该是D_PC，这也决定了<code>assign IMM_BEQ = &#123;&#123;14&#123;IMM[15]&#125;,IMM[15:0],2'b0&#125;&#125; + D_PC + 4</code>。</p>
<p>根据上述分析，我们可以同理得出，<code>assign IMM_J_Jal = &#123;D_PC[31:28],IMM,2&#39;b0&#125;</code></p>
<h2 id="D-GRF"><a href="#D-GRF" class="headerlink" title="D_GRF"></a>D_GRF</h2><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> D_GRF (</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] PC,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">4</span>:<span class="number">0</span>] A1,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">4</span>:<span class="number">0</span>] A2,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">4</span>:<span class="number">0</span>] A3,       </span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] WD,</span><br><span class="line">    <span class="keyword">input</span> clk,</span><br><span class="line">    <span class="keyword">input</span> reset,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] RD1,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] RD2</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>在<code>GRF</code>这个模块，虽然模块名称叫<code>D_GRF</code>(因为这里理论上只读，在W级才执行写操作)，但是由于全局<code>GRF</code>的唯一性，我们保留了<code>WD</code>,<code>A3</code>这两个写入数据必要的接口，当指令流水到<code>W级</code>时，根据<code>A3是否等于0</code>来决定是否写入。</p>
<p>为什么是根据<code>A3是否等于0</code>来决定是否写入呢，因为我们在这里为了简化设计采用了<code>隐式写使能</code>，即取消<code>显式WE信号</code>，转而通过<code>A3</code>的取值来决定是否写入<code>GRF</code>。</p>
<figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (A3 != <span class="number">0</span>) <span class="keyword">begin</span></span><br><span class="line">    register[A3] &lt;= WD;</span><br><span class="line">    display(<span class="string">&quot;%d@%h: $%d &lt;= %h&quot;</span>,<span class="built_in">$time</span>,PC,A3,WD);</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>对于<code>A3</code>的取值，<code>CTRL</code>模块会出手的，我们在<code>CTRL</code>会详细解释，这里大家只要留个印象即可。因为是在<code>W</code>级流水线写入，所以聪明的你应该可以感觉到<code>WD</code>，<code>A3</code>在<code>mips</code>模块实例化时对应的<code>wire</code>是什么了吧，没猜到也没关系，我们接着往下看。</p>
<figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">assign</span> RD1 = (A1 == <span class="number">0</span>) ? <span class="number">32&#x27;b0</span> : (A1 == A3) ? WD : register[A1];</span><br><span class="line"><span class="keyword">assign</span> RD2 = (A2 == <span class="number">0</span>) ? <span class="number">32&#x27;b0</span> : (A2 == A3) ? WD : register[A2];</span><br></pre></td></tr></table></figure>

<p>这段代码翻译过来就是，如果访问<code>0</code>号寄存器，直接给出<code>0</code>，如果访问的寄存器和<code>A3</code>冲突，那就给出<code>WD</code>的值，如果都不是，那就正常给出<code>register[A1]</code>。</p>
<p>当进入<code>A1</code>和<code>A3</code>冲突的分支时，那么<code>A3</code>一定不为<code>0</code>，相当于写使能有效。这段代码的作用就更加明显：**如果访问的寄存器和W级流水线将要写入的寄存器冲突，那么给出的值是将要写入的WD而不是现在的寄存器值register[A1]**。</p>
<p>这就是<strong>转发</strong>！！！只不过这是<code>GRF</code>内部转发，我们在<code>mips</code>模块中大量实现的是外部转发。大家还是留个印象，到时候再说😁。</p>
<h2 id="E-reg"><a href="#E-reg" class="headerlink" title="E_reg"></a>E_reg</h2><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> E_reg (</span><br><span class="line">    <span class="keyword">input</span> clk,</span><br><span class="line">    <span class="keyword">input</span> reset,</span><br><span class="line">    <span class="keyword">input</span> Flush,</span><br><span class="line">    <span class="keyword">input</span> WE,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] D_PC,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] D_Instr,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] D_EXT,   <span class="comment">//要用于ALU的计算</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] D_Rs_data, </span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] D_Rt_data,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] E_PC,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] E_Instr,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] E_EXT,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] E_Rs_data,   </span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] E_Rt_data</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><code>E_reg</code>的接口相较于<code>D_reg</code>又多了<code>D_EXT</code>,<code>D_Rs_data</code>,<code>D_Rt_data</code>,这三个量都是<code>E</code>级不可或缺的变量，所以也没什么可说的😥。</p>
<h2 id="E-ALU"><a href="#E-ALU" class="headerlink" title="E_ALU"></a>E_ALU</h2><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> E_ALU (</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] A,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] B,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">2</span>:<span class="number">0</span>] ALUOp,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] C  </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>这个也再正常不过了，我们下一个。</p>
<h2 id="M-reg"><a href="#M-reg" class="headerlink" title="M_reg"></a>M_reg</h2><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> M_reg (</span><br><span class="line">    <span class="keyword">input</span> Flush,</span><br><span class="line">    <span class="keyword">input</span> WE,</span><br><span class="line">    <span class="keyword">input</span> clk,</span><br><span class="line">    <span class="keyword">input</span> reset,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] E_PC,      </span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] E_Instr,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] E_Rt_data,  <span class="comment">//sw用</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] E_C,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] M_PC,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] M_Instr,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] M_Rt_data,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] M_C</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><code>M_reg</code>相较于<code>E_reg</code>多了<code>E_C</code>,这是<code>ALU</code>计算出的结果，肯定要往后流水，<code>M</code>级和<code>W</code>级都要用。少了的就是没用了，端口太多，全传过去有点抽象😥。</p>
<h2 id="M-DM"><a href="#M-DM" class="headerlink" title="M_DM"></a>M_DM</h2><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> M_DM (</span><br><span class="line">    <span class="keyword">input</span> clk,</span><br><span class="line">    <span class="keyword">input</span> reset,</span><br><span class="line">    <span class="keyword">input</span> DMWE,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] PC,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] Addr,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] WD,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] RD</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="W-reg"><a href="#W-reg" class="headerlink" title="W_reg"></a>W_reg</h2><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> W_reg (</span><br><span class="line">    <span class="keyword">input</span> clk,</span><br><span class="line">    <span class="keyword">input</span> reset,</span><br><span class="line">    <span class="keyword">input</span> Flush,</span><br><span class="line">    <span class="keyword">input</span> WE,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] M_PC,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] M_Instr,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] M_RD,       <span class="comment">//往GRF写入与DM的运算结果有关</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] M_C,        <span class="comment">//往GRF写入与ALU的运算结果有关</span></span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] W_PC,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] W_Instr,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] W_RD,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">31</span>:<span class="number">0</span>] W_C</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>至此，我们完成了各个元件的搭建，其实<code>P5</code>和<code>P4</code>相比，这些基本元件几乎没变，变的是<code>CTRL</code>，<code>mips</code>,还新增了<code>Stall</code>。</p>
<p>接下来就是<code>P5</code>的核心，也是最难的部分————<strong>阻塞与转发</strong>。</p>
<hr>
<h2 id="CTRL"><a href="#CTRL" class="headerlink" title="CTRL"></a>CTRL</h2><p>CTRL是译码器，主流的有两种设计方式：</p>
<p><strong>集中式译码</strong> ：在取指令（F 级）时或者读取寄存器阵列信息（D 级）前，将所有的控制信号全部解析出，然后让其随着流水往后逐级传递。</p>
<p><strong>分布式译码</strong> ：每一级都部署一个译码器，负责译出当前级所需控制信号。</p>
<p>为了尽可能减少一个模块中的接口数量，这里采用分布式译码。在设计CTRL模块时输出包含所有的<strong>控制信号</strong>以及<strong>rs,rt</strong>…在每一级可能会用到的信号，在<code>mips</code>模块中只需要在每一级流水线译出该级流水线所需的信号即可。</p>
<figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> CTRL (</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] Instr,</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">output</span> [<span class="number">4</span>:<span class="number">0</span>] Rs,     <span class="comment">//转发冲突判断</span></span><br><span class="line">    <span class="keyword">output</span> [<span class="number">4</span>:<span class="number">0</span>] Rt,     <span class="comment">//转发冲突判断</span></span><br><span class="line">    <span class="keyword">output</span> [<span class="number">4</span>:<span class="number">0</span>] Rd,     <span class="comment">//转发冲突判断的待选择信号</span></span><br><span class="line">    <span class="keyword">output</span> [<span class="number">15</span>:<span class="number">0</span>] Imm1,  <span class="comment">//EXT用</span></span><br><span class="line">    <span class="keyword">output</span> [<span class="number">25</span>:<span class="number">0</span>] Imm2,  <span class="comment">//NPC用</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">output</span> EXTOp,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">2</span>:<span class="number">0</span>] CMPOp,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">2</span>:<span class="number">0</span>] NPCOp,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">2</span>:<span class="number">0</span>] ALUOp,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">2</span>:<span class="number">0</span>] ALUBSel,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">2</span>:<span class="number">0</span>] GRFWDSel,</span><br><span class="line">    <span class="keyword">output</span> [<span class="number">4</span>:<span class="number">0</span>] GRFA3Sel,</span><br><span class="line">    <span class="keyword">output</span> DMWE,</span><br><span class="line">    <span class="comment">//配合Stall</span></span><br><span class="line">    <span class="keyword">output</span> Add,</span><br><span class="line">    <span class="keyword">output</span> Sub,</span><br><span class="line">    <span class="keyword">output</span> Ori,</span><br><span class="line">    <span class="keyword">output</span> Lw,</span><br><span class="line">    <span class="keyword">output</span> Sw,</span><br><span class="line">    <span class="keyword">output</span> Beq,</span><br><span class="line">    <span class="keyword">output</span> Lui,</span><br><span class="line">    <span class="keyword">output</span> Sll,</span><br><span class="line">    <span class="keyword">output</span> J,</span><br><span class="line">    <span class="keyword">output</span> Jal,</span><br><span class="line">    <span class="keyword">output</span> Jr,</span><br><span class="line">    <span class="keyword">output</span> Jalr</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>控制信号具体值可以参看译码表。如图：</p>
<table>
<thead>
<tr>
<th align="center">指令</th>
<th align="center">opcode(31:26)</th>
<th align="center">funct(5:0)</th>
<th align="center">EXTOp</th>
<th align="center">CMPOp</th>
<th align="center">NPCOp</th>
<th align="center">ALUOp</th>
<th align="center">ALUBSel</th>
<th align="center">GRFWDSel</th>
<th align="center">GRFA3Sel</th>
<th align="center">DMWE</th>
</tr>
</thead>
<tbody><tr>
<td align="center">功能</td>
<td align="center">opcode</td>
<td align="center">func</td>
<td align="center">立即数扩展</td>
<td align="center">比较器操作</td>
<td align="center">下一条PC计算</td>
<td align="center">ALU运算</td>
<td align="center">ALUB端口选择</td>
<td align="center">GRF写回数据来源</td>
<td align="center">GRF写回地址选择</td>
<td align="center">数据存储器写使能</td>
</tr>
<tr>
<td align="center">add</td>
<td align="center">000000</td>
<td align="center">100000</td>
<td align="center">EXT_ZERO</td>
<td align="center">CMP_BEQ</td>
<td align="center">NPC_PC4</td>
<td align="center">ALU_add</td>
<td align="center">ALUBrt</td>
<td align="center">GRFWDALU</td>
<td align="center">GRFA3rd</td>
<td align="center">DMWE_ZERO</td>
</tr>
<tr>
<td align="center">sub</td>
<td align="center">000000</td>
<td align="center">100010</td>
<td align="center">EXT_ZERO</td>
<td align="center">CMP_BEQ</td>
<td align="center">NPC_PC4</td>
<td align="center">ALU_sub</td>
<td align="center">ALUBrt</td>
<td align="center">GRFWDALU</td>
<td align="center">GRFA3rd</td>
<td align="center">DMWE_ZERO</td>
</tr>
<tr>
<td align="center">ori</td>
<td align="center">001101</td>
<td align="center">x</td>
<td align="center">EXT_ZERO</td>
<td align="center">CMP_BEQ</td>
<td align="center">NPC_PC4</td>
<td align="center">ALU_ori</td>
<td align="center">ALUBimm</td>
<td align="center">GRFWDALU</td>
<td align="center">GRFA3rt</td>
<td align="center">DMWE_ZERO</td>
</tr>
<tr>
<td align="center">lw</td>
<td align="center">100011</td>
<td align="center">x</td>
<td align="center">EXT_SIGN</td>
<td align="center">CMP_BEQ</td>
<td align="center">NPC_PC4</td>
<td align="center">ALU_add</td>
<td align="center">ALUBimm</td>
<td align="center">GRFWDDM</td>
<td align="center">GRFA3rt</td>
<td align="center">DMWE_ZERO</td>
</tr>
<tr>
<td align="center">sw</td>
<td align="center">101011</td>
<td align="center">x</td>
<td align="center">EXT_SIGN</td>
<td align="center">CMP_BEQ</td>
<td align="center">NPC_PC4</td>
<td align="center">ALU_add</td>
<td align="center">ALUBimm</td>
<td align="center">GRFWDALU</td>
<td align="center">GRFA3rt</td>
<td align="center">DMWE_ONE</td>
</tr>
<tr>
<td align="center">beq</td>
<td align="center">000100</td>
<td align="center">x</td>
<td align="center">EXT_ZERO</td>
<td align="center">CMP_BEQ</td>
<td align="center">NPC_BEQ</td>
<td align="center">ALU_sub</td>
<td align="center">ALUBrt</td>
<td align="center">GRFWDALU</td>
<td align="center">GRFA3rt</td>
<td align="center">DMWE_ZERO</td>
</tr>
<tr>
<td align="center">lui</td>
<td align="center">001111</td>
<td align="center">x</td>
<td align="center">EXT_ZERO</td>
<td align="center">CMP_BEQ</td>
<td align="center">NPC_PC4</td>
<td align="center">ALU_lui</td>
<td align="center">ALUBimm</td>
<td align="center">GRFWDALU</td>
<td align="center">GRFA3rt</td>
<td align="center">DMWE_ZERO</td>
</tr>
<tr>
<td align="center">sll</td>
<td align="center">000000</td>
<td align="center">000000</td>
<td align="center">EXT_ZERO</td>
<td align="center">CMP_BEQ</td>
<td align="center">NPC_PC4</td>
<td align="center">ALU_sll</td>
<td align="center">ALUBrt</td>
<td align="center">GRFWDALU</td>
<td align="center">GRFA3rd</td>
<td align="center">DMWE_ZERO</td>
</tr>
<tr>
<td align="center">j</td>
<td align="center">000010</td>
<td align="center">x</td>
<td align="center">EXT_ZERO</td>
<td align="center">CMP_BEQ</td>
<td align="center">NPC_J_Jal</td>
<td align="center">ALU_add</td>
<td align="center">ALUBrt</td>
<td align="center">GRFWDALU</td>
<td align="center">GRFA3rt</td>
<td align="center">DMWE_ZERO</td>
</tr>
<tr>
<td align="center">jal</td>
<td align="center">000011</td>
<td align="center">x</td>
<td align="center">EXT_ZERO</td>
<td align="center">CMP_BEQ</td>
<td align="center">NPC_J_Jal</td>
<td align="center">ALU_add</td>
<td align="center">ALUBrt</td>
<td align="center">GRFWDPC8</td>
<td align="center">GRFA331</td>
<td align="center">DMWE_ZERO</td>
</tr>
<tr>
<td align="center">jr</td>
<td align="center">000000</td>
<td align="center">001000</td>
<td align="center">EXT_ZERO</td>
<td align="center">CMP_BEQ</td>
<td align="center">NPC_Jr_Jalr</td>
<td align="center">ALU_add</td>
<td align="center">ALUBrt</td>
<td align="center">GRFWDALU</td>
<td align="center">GRFA3rd</td>
<td align="center">DMWE_ZERO</td>
</tr>
<tr>
<td align="center">jalr</td>
<td align="center">000000</td>
<td align="center">001001</td>
<td align="center">EXT_ZERO</td>
<td align="center">CMP_BEQ</td>
<td align="center">NPC_Jr_Jalr</td>
<td align="center">ALU_add</td>
<td align="center">ALUBrt</td>
<td align="center">GRFWDPC8</td>
<td align="center">GRFA3rd</td>
<td align="center">DMWE_ZERO</td>
</tr>
</tbody></table>
<h2 id="Stall"><a href="#Stall" class="headerlink" title="Stall"></a>Stall</h2><p>阻塞的概念是,当我们发现单凭转发已经不足以解决读写冲突的问题时，不得不让当前指令停在<strong>D级</strong>，直到随流水线流水的指令产生写入数据的时间<code>(Tnew)</code>小于等于D级指令将要读取寄存器的时间<code>(Tuse)</code>,D级流水线寄存器才<strong>放行</strong>，在这期间一直是<code>nop</code>从<code>E</code>级不断向后流水。</p>
<p>这里我们对<strong>Tnew</strong>和<strong>Tuse</strong>做详细阐释：</p>
<p><strong>Tuse</strong>:对于某一个指令的某一个数据需求，我们定义需求时间<strong>Tuse</strong>为：</p>
<p>这条指令位于 <strong>D</strong> 级的时候，再经过多少个时钟周期就必须要使用相应的数据。例如，对于 <code>beq</code> 指令，立刻就要使用数据，所以 <code>Tuse = 0</code>;对于 <code>add</code> 指令，等待下一个时钟周期它进入 E 级才要使用数据，所以 <code>T_use = 1</code>;而对于 <code>sw</code> 指令，在 E 级它需要 GPR[rs] 的数据来计算地址，在 M 级需要 GPR[rt] 来存入值，所以 <code>rs_Tuse = 1,rt_Tuse = 2</code>。</p>
<p><strong>Tnew</strong>: 对于某个指令的数据产出，我们定义供给时间<strong>Tnew</strong>为：</p>
<p>位于<strong>某个流水级</strong>的某个指令，它经过多少个时钟周期可以算出结果并且存储到<strong>流水级寄存器</strong>里。注意是<strong>流水级寄存器</strong>，不是<strong>GRF</strong>。对于 <code>add</code> 指令，当它处于 E 级，此时结果还没有存储到流水级寄存器里，所以此时它的 <code>Tnew = 1</code>,而当它处于 M 或者 W 级，此时结果已经写入了流水级寄存器，所以此时 <code>Tnew = 0</code>.</p>
<blockquote>
<p>当Tnew &gt; Tuse 时，数据不能及时算出，需要通过阻塞来解决。<br>当Tnew &lt;&#x3D; Tuse 数据能够及时算出，可以转发解决。</p>
</blockquote>
<p>由于<code>Tnew</code>的是一个<strong>动态值</strong>，而<code>Tuse</code>为一个<strong>静态值</strong>，随着<code>Tnew</code>的不断减小，当<code>Tnew = Tuse</code> 时，D级流水线寄存器就可以<strong>放行</strong>了。以上就是阻塞的大概过程，我们看具体的代码再做理解。</p>
<figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> STALL (</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] D_instr,   </span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] E_instr,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] M_instr,</span><br><span class="line">    <span class="keyword">output</span> Stall</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>在D级只产生<code>Tuse</code>,在<code>E</code>，<code>M</code>级产生<code>Tnew</code>,(W级Tnew恒等于0)我们只需要分三个区间分别写出对应的<code>Tnew</code>,<code>Tuse</code>,然后列出阻塞情况，最后通过<strong>或运算</strong>就可以得到阻塞信号<code>Stall</code>;</p>
<figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">assign</span> E_stall_rs = (D_rs == E_GRFA3 &amp;&amp; (D_rs != <span class="number">0</span>)) &amp;&amp; (rs_Tuse &lt; E_Tnew);</span><br><span class="line"><span class="keyword">assign</span> E_stall_rt = (D_rt == E_GRFA3 &amp;&amp; (D_rt != <span class="number">0</span>)) &amp;&amp; (rt_Tuse &lt; E_Tnew);</span><br><span class="line"><span class="keyword">assign</span> M_stall_rs = (D_rs == M_GRFA3 &amp;&amp; (D_rs != <span class="number">0</span>)) &amp;&amp; (rs_Tuse &lt; M_Tnew);</span><br><span class="line"><span class="keyword">assign</span> M_stall_rt = (D_rt == M_GRFA3 &amp;&amp; (D_rt != <span class="number">0</span>)) &amp;&amp; (rt_Tuse &lt; M_Tnew);</span><br><span class="line"><span class="keyword">assign</span> Stall = E_stall_rs | E_stall_rt | M_stall_rs | M_stall_rt;</span><br></pre></td></tr></table></figure>

<p>第一行代表的含义是<strong>E级导致阻塞，rs地址冲突</strong>。注意，当<code>rs = 0</code>是，默认寄存器的值已知，不需要阻塞。这里附上<code>Tnew</code>和<code>Tuse</code>的阻塞表。</p>
<p><strong>D_Tuse</strong>:</p>
<table>
<thead>
<tr>
<th align="center">指令</th>
<th align="center">add</th>
<th align="center">sub</th>
<th align="center">ori</th>
<th align="center">lw</th>
<th align="center">sw</th>
<th align="center">beq</th>
<th align="center">lui</th>
<th align="center">sll</th>
<th align="center">j</th>
<th align="center">jr</th>
<th align="center">jal</th>
<th align="center">jalr</th>
</tr>
</thead>
<tbody><tr>
<td align="center">D_rs_Tuse</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">3</td>
<td align="center">3</td>
<td align="center">0</td>
<td align="center">3</td>
<td align="center">0</td>
</tr>
<tr>
<td align="center">D_rt_Tuse</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">3</td>
<td align="center">3</td>
<td align="center">2</td>
<td align="center">0</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">3</td>
<td align="center">3</td>
<td align="center">3</td>
<td align="center">3</td>
</tr>
</tbody></table>
<p><strong>E_Tnew &amp; M_Tnew</strong>:</p>
<table>
<thead>
<tr>
<th align="center">指令</th>
<th align="center">add</th>
<th align="center">sub</th>
<th align="center">ori</th>
<th align="center">lw</th>
<th align="center">sw</th>
<th align="center">beq</th>
<th align="center">lui</th>
<th align="center">sll</th>
<th align="center">j</th>
<th align="center">jr</th>
<th align="center">jal</th>
<th align="center">jalr</th>
</tr>
</thead>
<tbody><tr>
<td align="center">E_Tnew</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
<tr>
<td align="center">M_Tnew</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
</tbody></table>
<h2 id="mips"><a href="#mips" class="headerlink" title="mips"></a>mips</h2><p>阻塞处理完，我们就要开始实例化模块并连接电路了，连接过程中实现<strong>外部转发</strong>，我们的五级流水线CPU就基本搭建完成了。总体来说，我们的设计主线是模块的实例化，在实例化过程中我们会发现某个需要使用的变量的缺失，这时我们在每一级的固定定义区定义我们需要的<code>wire</code>类型变量即可，大家完全不必纠结于在每一个模块开始时定义什么。</p>
<p><strong>特别的，E_GRFa3,E_GRFwd系列的指令需要在开头定义，因为这些指令如果在对应模块定义的话就会出现在定义前使用的情况，使用时编译器会自动隐式定义为1位的wire变量，如果你在之后再次定义的话，编译器会报错重复定义</strong>。</p>
<p>笔者这里在全局定义区定义了常用变量，大家可以参考这种定义方式，也可以放在固定的流水级，<strong>你开心就好</strong>😊</p>
<figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="comment">//各级PC和Instr</span></span><br><span class="line"><span class="keyword">wire</span> [<span class="number">31</span>:<span class="number">0</span>] F_pc,F_instr,D_pc,D_instr,E_pc,E_instr,M_pc,M_instr,W_pc,W_instr;</span><br><span class="line"><span class="comment">//阻塞信号</span></span><br><span class="line"><span class="keyword">wire</span> stall;</span><br><span class="line"><span class="comment">//各级流水线寄存器使能信号和刷新信号</span></span><br><span class="line"><span class="keyword">wire</span> D_reg_flush,E_reg_flush,M_reg_flush,W_reg_flush,D_reg_we,E_reg_we,M_reg_we,W_reg_we;</span><br><span class="line"><span class="comment">//PC的使能信号</span></span><br><span class="line"><span class="keyword">wire</span> PCwe;</span><br></pre></td></tr></table></figure>

<p>接下来强调几个重要的模块。</p>
<h3 id="stall"><a href="#stall" class="headerlink" title="stall"></a>stall</h3><p>阻塞模块是全局变量，需要作为单独一个实例来控制各个流水线寄存器的运作，Stall的取值可能会影响的变量是<code>PC_we</code>,<code>D_reg_we</code>,<code>E_reg_flush</code>。</p>
<h3 id="D级"><a href="#D级" class="headerlink" title="D级"></a>D级</h3><p><code>D</code>级<code>GRF</code>实例化时<code>A3</code>接口和<code>WD</code>接口分别接<code>W_GRFa3</code>和<code>W_GRFwd</code>，从而实现GRF<strong>内部转发</strong>。而由于W级实现了内部转发，我们在转发<code>D_For_rs_data</code>和<code>D_For_rt_data</code>时只转发<code>E</code>，<code>M</code>即可：</p>
<figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="keyword">assign</span> D_For_rs_data = (D_rs == <span class="number">5&#x27;d0</span>) ? <span class="number">32&#x27;d0</span> :</span><br><span class="line">                       (D_rs == E_GRFa3) ? E_GRFwd :</span><br><span class="line">                       (D_rs == M_GRFa3) ? M_GRFwd :</span><br><span class="line">                       D_rs_data;</span><br></pre></td></tr></table></figure>

<p>这里很多同学会问，转发时如何保证<code>E_GRFwd</code>，<code>M_GRFwd</code>已经算出来了呢，其实很简单，当你在执行转发时，是不是说明<strong>不需要阻塞了</strong>，那不需要阻塞是否意味着你要的东西已经算出来了呢？</p>
<p>注意<code>D_NPC</code>和<code>D_CMP</code>用的<code>D_rs_data</code>和<code>D_rt_data</code>都是<strong>转发后的</strong>。</p>
<h3 id="E级"><a href="#E级" class="headerlink" title="E级"></a>E级</h3><p>因为<code>E</code>级没有<code>GRF</code>，即没有内部转发，因此<code>E</code>级<code>E_For_rs_data</code>和<code>E_For_rt_data</code>需要转发<code>M</code>，<code>W</code>。并且在<code>E</code>级要实现<code>E_GRFa3</code>和<code>E_GRFwd</code>这两个转发必要的数据赋值，<code>E_GRFa3</code>实现没什么坑点，值得一提的是，<code>E_GRFwd</code>没有<code>DMrd</code>这个选项，因为在<code>E</code>级，还没有算出<code>M</code>级的结果。</p>
<p>注意<code>E_ALU</code>用的<code>E_rs_data</code>和<code>E_rt_data</code>是<strong>转发后的</strong>。</p>
<h3 id="M级"><a href="#M级" class="headerlink" title="M级"></a>M级</h3><p><code>M</code>级只需要转发<code>rt_data</code>,因为<code>rs_data</code>不会在<code>M</code>级被使用。同理实现<code>M_GRFa3</code>和<code>M_GRFwd</code>，此时<code>M_GRFwd</code>有了<code>DMrd</code>这个选项。</p>
<p>注意<code>M_DM</code>用的<code>M_rt_data</code>是<strong>转发后</strong>的结果。</p>
<h3 id="W级"><a href="#W级" class="headerlink" title="W级"></a>W级</h3><p><code>W</code>级没什么好转发的，只需要实现<code>W_GRFa3</code>和<code>W_GRFwd</code>即可。</p>
<h2 id="Some-Tips"><a href="#Some-Tips" class="headerlink" title="Some Tips"></a>Some Tips</h2><ol>
<li>P5确实难，大家如果一开始上不了手也完全没关系，这不是你的问题。</li>
<li>老师会建议大家先写设计文档，再搭建CPU。听着很有道理哈，但是对于大部分同学来说听完理论课根本不知道从哪里下手，只能死磕设计文档。你可以把死磕设计文档理解成<strong>盯着markdown学P5</strong>，你就知道这种<strong>推荐行为</strong>有多搞笑了……(当然大佬除外，确实有些同学是具备直接上手设计文档的能力的)。我的建议是大家完全可以直接照着学长的博客搭一遍，搭的过程中你一定会有很多疑问，只要做标记就好，在你搭建的过程中你会对某些问题有自己的理解，在搭建完成后再把整个CPU过一遍，找出自己不理解的地方专项攻克。在做完这些工作之后你一定会对流水线CPU有更深刻的理解，这时你再把<code>Stall</code>，<code>mips</code>，<code>CTRL</code>这三个重点模块自己重新写一遍，就形成了属于自己的CPU。个人感觉这种<strong>盯着代码学P5</strong>要比<strong>盯着markdown学P5</strong>好很多。</li>
<li>这篇Blog只是介绍了课下的基础指令，单凭这些工作就想<strong>P5课上过，片叶不沾身</strong>有点困难，我们还需要完善某些接口，详见关于P5课上的<a href="https">这篇博客</a>。</li>
</ol>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>P5作为流水线CPU的开山之P，是后面几次实验的基础，同学们要认真对待。这篇博客说了这么多，虽然不能让你在看完之后立刻原地完美搭建5级流水线CPU，但是只要其中的一些细节解释能给你些许灵感,足矣。</p>
<h2 id="Lyrics-Sharing"><a href="#Lyrics-Sharing" class="headerlink" title="Lyrics Sharing"></a>Lyrics Sharing</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">修炼爱情的悲欢</span><br><span class="line">我们这些努力不简单</span><br><span class="line">快乐炼成泪水</span><br><span class="line">是一种勇敢</span><br><span class="line">几年前的幻想</span><br><span class="line">几年后的原谅</span><br><span class="line">为一张脸去养一身伤</span><br><span class="line">别讲想念我</span><br><span class="line">我会受不了这样</span><br><span class="line">笑着说爱让人疯狂</span><br><span class="line">哭着说爱让人紧张</span><br><span class="line">忘不了那个人就投降</span><br></pre></td></tr></table></figure>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Cordial-Kid</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://Cordial-Kid.github.io/2026/01/21/P5%E8%AF%BE%E4%B8%8B/">https://Cordial-Kid.github.io/2026/01/21/P5%E8%AF%BE%E4%B8%8B/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Cordial-Kid</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/BUAA/">
                                    <span class="chip bg-color">BUAA</span>
                                </a>
                            
                                <a href="/tags/verilog/">
                                    <span class="chip bg-color">verilog</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2026/01/21/P5%E8%AF%BE%E4%B8%8B/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="「BUAA-CO」 P5课下">
                        
                        <span class="card-title">「BUAA-CO」 P5课下</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2026-01-21
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90/" class="post-category">
                                    计算机组成
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/BUAA/">
                        <span class="chip bg-color">BUAA</span>
                    </a>
                    
                    <a href="/tags/verilog/">
                        <span class="chip bg-color">verilog</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2026/01/21/P5%E8%AF%BE%E4%B8%8A/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="「BUAA-CO」P5课上">
                        
                        <span class="card-title">「BUAA-CO」P5课上</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2026-01-21
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90/" class="post-category">
                                    计算机组成
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/BUAA/">
                        <span class="chip bg-color">BUAA</span>
                    </a>
                    
                    <a href="/tags/verilog/">
                        <span class="chip bg-color">verilog</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>



<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2026</span>
            
            <a href="/about" target="_blank">Cordial-Kid</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">17k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Cordial-Kid" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:24373163@buaa.edu.cn" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=3454976847" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 3454976847" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/snow.js"><\/script>');
            }
        </script>
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
